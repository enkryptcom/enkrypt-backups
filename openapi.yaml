# openapi.yaml
openapi: 3.1.0
info:
  title: Enkrypt Backend API
  version: 1.0.0
paths:
  /version:
    get:
      responses:
        200:
          $ref: '#/components/responses/GetVersionSuccess'

  /health:
    get:
      responses:
        200:
          $ref: '#/components/responses/GetHealthSuccess'

  /schema:
    get:
      responses:
        200:
          $ref: '#/components/responses/GetSchemaSuccess'

  /backups/{pubkey}:
    get:
      parameters:
        - $ref: '#/components/parameters/pubkey'
      responses:
        200:
          $ref: '#/components/responses/GetBackupsSuccess'

  /backups/{pubkey}/{userId}:
    post:
      parameters:
        - $ref: '#/components/parameters/Pubkey'
        - $ref: '#/components/parameters/UserId'
      requestBody:
        $ref: '#/components/requestBodies/PostBackup'
      responses:
        200:
          $ref: '#/components/responses/PostBackupSuccess'

components:
  parameters:
    Pubkey:
      name: pubkey
      in: path
      # required: true # OpenAPI 3.0 property not compatible with JSON schema
      schema:
        $ref: '#/components/schemas/Bytes64'

    UserId:
      name: userId
      in: path
      # required: true # OpenAPI 3.0 property not compatible with JSON schema
      schema:
        $ref: '#/components/schemas/UUID'

  requestBodies:
    PostBackup:
      description: hi!
      content:
        application/json:
          $ref: '#/components/schemas/PostBackupRequest'

  responses:
    GetVersionSuccess:
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GetVersionResponse'

    GetHealthSuccess:
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GetHealthResponse'

    GetSchemaSuccess:
      content:
        application/yaml:
          schema:
            $ref: '#/components/schemas/GetSchemaResponse'

    GetBackupsSuccess:
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GetBackupsResponse'

    PostBackupSuccess:
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/PostBackupResponse'

  schemas:
    ByteString:
      type: string
      pattern: ^0x([0-9a-fA-F]{2})*$
    Bytes32:
      type: string
      pattern: ^0x[0-9a-fA-F]{64}$
    Bytes64:
      type: string
      pattern: ^0x[0-9a-fA-F]{128}$
    Hex:
      type: string
      pattern: ^0x[0-9a-fA-F]*$
    UUID:
      type: string
      pattern: ^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$

    GetHealthResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string

    GetVersionResponse:
      type: object
      required:
        - version
      properties:
        version:
          type: string

    GetSchemaResponse:
      type: string

    PostBackupRequest:
      type: object
      required:
        - signature
        - payload
      properties:
        signature:
          $ref: '#/components/schemas/ByteString'
        payload:
          $ref: '#/components/schemas/ByteString'

    PostBackupResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string

    GetBackupsResponse:
      type: array
      items:
        $ref: '#/components/schemas/GetBackupsResponseItem'

    GetBackupsResponseItem:
      type: object
      required:
        - updatedAt
        - userId
        - payload
      properties:
        updatedAt:
          type: string
          format: date-time
        userId:
          type: string
        payload:
          $ref: '#/components/schemas/ByteString'
